{% extends "events/base.html" %}

{% load static %}

{% block title %}
Events
{% endblock %}

{% block extra_styles %}
<style>   
    .sticky-note-container-big {
        width: 100%;
        background-color: rgba(255,255,255,0.1);
        /* padding: 20px; */
        /* border-radius: 5px; */
        /* box-shadow: 5px 5px 15px rgba(0,0,0,0.2); */
        margin: 0;
    }
    .filter-form {
        padding-left: 2rem;
        margin-bottom: 20px;
        font-weight: bold;
    }
    .search_name {
        border-radius: 5px;
        box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
        margin-right: 20px;
    }

    li.event-item {
        list-style: none;
        background-color: #f6f6f6;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
    }

    .button-container {
        padding-left: 2rem;
        display: flex;
        justify-content: space-between;
    }

    .button-container form {
        margin: 0;
    }

    .event-image img{
        object-fit: cover;
        width: 100%;
        height: 100%;
    }

    .event-button-container {
        display: flex;
        justify-content: space-between;
    }

    /* .bg-blue {
        background-color: #a6cff4;
    } */

    #map{
        position: sticky !important;
        height: 100dvh;
        width: 50%;
        align-items: flex-start;
        top:0;
    }
    .container{
        display: flex;
        padding: 0;
        align-items: start;
        
        <nav class="navbar navbar-expand-lg navbar-light bg-light px-5">
            <!-- Brand/logo -->
            <a class="navbar-brand" href="{% url 'events:index' %}">Cheerâ†‘</a>
            
            <!-- Toggler/collapsible Button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Navbar links -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'events:index' %}">Find Events</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'events:create-event' %}">Create an Event</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'notifications:notifications' %}">Notifications</a>
                    </li>
                    <!-- <li class="nav-item">
                        <a class="nav-link" href="#">Contact</a>
                    </li> -->
                </ul>
                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="#">Hello {{ user.username }}</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'logout' %}?next={{ request.path }}">Log out</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            {% if request.resolver_match.url_name == 'signup' %}  <!-- Check if current path is the signup page -->
                                <a class="nav-link" href="{% url 'login' %}?next={% url 'events:index' %}">Log in</a>
                            {% else %}
                                <a class="nav-link" href="{% url 'login' %}?next={{ request.path }}">Log in</a>
                            {% endif %}
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'signup' %}?next={{ request.path }}">Sign up</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </nav>
    </header>
    }


    .background-transparent {
        background-color: rgba(255,255,255,0.2);
    }

</style>
{% endblock %}

    {% block content %}
        {% if messages %}
            <div id="messages">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dimissable fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-bs-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        <div class="container">
        <div class="sticky-note-container-big mx-4">
            <div class="button-container my-4">
                <h2>Find Your Next Event</h2>    
                <input id="eventsButton" type="button" name="events_near_me" value="Events near me" class="btn btn-secondary" onclick="toggleButton()">
            </div>

            <!-- Filtering form -->
            <form method="get" action="{% url 'events:index' %}" class="filter-form" onsubmit="return validateForm()">
                
                <label for="start_time">Start Time:</label>
                <input type="datetime-local" name="start_time" id="start_time">

                <label for="end_time">End Time:</label>
                <input type="datetime-local" name="end_time" id="end_time">
                <div class="padding-16"></div>
                <br>
                <label for="min_capacity">Minimum Capacity:</label>
                <input type="number" id="min_capacity" name="min_capacity" min="0" value="0">
                
                <label for="max_capacity">Maximum Capacity:</label>
                <input type="number" id="max_capacity" name="max_capacity" min="0" value="100">
                <br>
                <br>
                <label for="tags">Tags</label>
                {{form.tags}}
                <br>

                <div class="padding-16"></div>
                <br>
                <label for="search_name">Search Events:</label>
                <input type="text" name="search" class="search_name" id="search_name" placeholder=" Event Name or Location...">
                <div class="padding-16"></div>
                <br>
                <label for="favorite_location_events">Events on favorite locations:</label>
                <input type="checkbox" name="favorite_location_events" id="favorite_location_events">
                <br>
                <div class="row justify-content-end mx-1">   
                    <input type="submit" value="Filter" class="col-auto btn btn-secondary mx-2">
                    <input type="submit" name="reset_filters" value="Reset Filters" class="col-auto btn btn-outline-secondary">
                </div>

            </form>

            <!-- Error messages for invalid input -->
            {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
            {% endif %}
            <ul>
                {% for event in events %}
                    <div class="card my-4 background-transparent">
                        <div class="row g-0">
                            <div class="col-md-5 event-image">
                                <img src="{% static 'events/images/Image_Placeholder.jpg' %}" alt="..." class="rounded-start">
                            </div>
                            <div class="col-md-7">
                                <div class="card-body">
                                    <a href="{% url 'events:event-detail' event.id %}" class="card-title fs-4 fw-bold mb-5">{{ event.event_name }}</a>
                                    <h5 class="card-text">{{ event.start_time }} - {{ event.end_time }}</h5>
                                    <h6 class="card-text">Location: {{ event.event_location }}</h6>
                                    <h6 class="card-text">Capacity: {{ event.capacity }}</h6>
                                    {% if user.is_authenticated and user == event.creator %}
                                        <div class="event-button-container mt-3">
                                            <form method="GET" action="{% url 'events:update-event' event.id %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="delete">
                                                <button class="btn btn-primary" type="submit">Update Event</button>
                                            </form>
                                            <form method="post" action="{% url 'events:delete-event' event.id %}" onsubmit="return confirm('Are you sure you want to delete this event?');">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="delete">
                                                <button class="btn btn-outline-primary" type="submit">Delete Event</button>
                                            </form>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                <li>No events that fit your schedule? How about <button class="btn btn-secondary" onclick='window.location="{% url 'events:create-event' %}";'>CREATING</button> one?</li>
                {% endfor %}
            </ul>
        </div>
        <div id="map"></div>
    </div>
        {% endblock %}

    {% block extra_scripts %}
    <script src="{% static 'events/js/script.js' %}"></script>
    <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDuFnfuacTqMttUXdVn24zdfGUHRi0XN5E&map_ids=9a7e26117f10196d&callback=initMap">
    </script>
    <script>
        
        function getQueryParameters() {
    var queryString = window.location.search.slice(1);
    var params = {};

    if (queryString) {
        var keyValuePairs = queryString.split('&');
        keyValuePairs.forEach(function(keyValuePair) {
        var pair = keyValuePair.split('=');
        var key = decodeURIComponent(pair[0]);
        var value = decodeURIComponent(pair[1]);
        params[key] = value;
        });
    }

    return params;
    }
        window.addEventListener('load', function() {
        var queryParameters = getQueryParameters();
        // Populate the form fields if the query parameters exist
        if (queryParameters.start_time) {
            document.getElementById('start_time').value = queryParameters.start_time;
        }
        if (queryParameters.favorite_location_events && queryParameters.favorite_location_events == "on") {
            checkbox = document.getElementById('favorite_location_events')
            checkbox.checked = true;
        }
        if (queryParameters.end_time) {
            document.getElementById('end_time').value = queryParameters.end_time;
        }
        if (queryParameters.min_capacity) {
            document.getElementById('min_capacity').value = queryParameters.min_capacity;
        }
        if (queryParameters.max_capacity) {
            document.getElementById('max_capacity').value = queryParameters.max_capacity;
        }
        if (queryParameters.search) {
            document.getElementById('search_name').value = queryParameters.search;
        }
        if (queryParameters.events_near_me && queryParameters.events_near_me == "true") {
            const toggleButton=document.getElementById('eventsButton');
            toggleButton.classList.remove("btn-secondary")
            toggleButton.classList.add("btn-primary")
        }
        });
        
        function validateForm() {
          var startTime = document.getElementById('start_time').value;
          var endTime = document.getElementById('end_time').value;
          var minCapacity = document.getElementById('min_capacity').value;
          var maxCapacity = document.getElementById('max_capacity').value;
          var now = new Date().toISOString().slice(0, 16); // match the format of the datetime-local input
          
          if (startTime && startTime < now) {
            alert('Start time cannot be in the past.');
            return false;
          }
          
          if (endTime && startTime && endTime <= startTime) {
            alert('End time cannot be before start time.');
            return false;
          }
          if (minCapacity && maxCapacity && parseInt(minCapacity) > parseInt(maxCapacity)) {
            alert('Minimum capacity cannot be greater than maximum capacity.');
            return false;
          }
          
          return true;
        }

    const urlParams = new URLSearchParams(window.location.search);
    const error_message = urlParams.get('error_message');

    // Display the error message if it exists
    if (error_message) {
        alert(error_message)
    }
    // Remove the error message from the URL
    urlParams.delete('error_message');
    const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
    window.history.replaceState({}, document.title, newUrl);
    function showPosition(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;
        urlParams.set('lat', latitude);
        urlParams.set('lon', longitude);
    // Send latitude and longitude to the server
    window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
    }
    function toggleButton() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);   
            var button = document.getElementById("eventsButton");
            console.log(button.classList)
            if (button.classList.contains("btn-secondary")) {
                urlParams.set('events_near_me', true);
                button.classList.remove("btn-secondary");
                button.classList.add("btn-primary");
            } else {
                urlParams.set('events_near_me', false);
                button.classList.remove("btn-primary");
                button.classList.add("btn-secondary");
            }
            window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
            }
        else{
            alert("we are unable to fetch your location!")
        }    
    }
    
    </script>   
    
    {% endblock %}

